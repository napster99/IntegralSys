<!doctype html>
<html>
<head>
	<meta charset="utf-8" />
	<title>钓鱼赛事积分系统</title>
	<link rel="stylesheet" href="css/bootstrap.css">
	<style>

		h1{
			margin-left: 15px;
		}

		table.hovertable {
			font-family: verdana,arial,sans-serif;
			font-size:11px;
			color:#333333;
			border-width: 1px;
			border-color: #999999;
			border-collapse: collapse;
			width: 500px;
			margin-top: 30px;
		}

		table.hovertable th {
			background-color:#c3dde0;
			border-width: 1px;
			padding: 8px;
			border-style: solid;
			border-color: #a9c6c9;
		}

		table.hovertable tr {
			background-color:#d4e3e5;
		}

		table.hovertable td {
			border-width: 1px;
			padding: 8px;
			border-style: solid;
			border-color: #a9c6c9;
		}

		.ml15 {
			margin-left: 15px !important;
		}

		.pt30{
			padding-top: 30px !important;
		}

		.drawtable{
			margin: 10px;
		}

		td{
			border : 1px solid;
		}

		.ranktable{
			border-top: 1px solid;
			margin-top: 40px;
		}
		.userOptionEdit {
			float: right;
		}

	</style>
</head>
<body onselectstart="return false" style="-moz-user-select:none;">
	<h1>钓鱼赛事 积分系统<button id="resetBtn" class="btn btn-primary ml15">重置比赛</button></h1>
	<hr />
	<ul class="nav nav-tabs first-tabs">
	  <li name="luru" class="active"><a href="javascript:;">选手录入</a></li>
	  <li name="peizhi"><a href="javascript:;">配置</a></li>
	  <li name="chouqian"><a href="javascript:;">抽签</a></li>
	  <li name="chengji"><a href="javascript:;">成绩录入</a></li>
	  <li name="mingci"><a href="javascript:;">得分排名</a></li>
	</ul>

	<div name="content" id="luru">
		<div class="form-inline" style="padding:60px;">
		  <div class="form-group">
		    <label for="exampleInputName2">姓名</label>
		    <input type="text" class="form-control" id="userName" placeholder="选手姓名">
		  </div>
		  <div class="form-group ml15">
		    <label for="exampleInputEmail2">城市</label>
		    <input type="email" class="form-control" id="userCity" placeholder="来自的城市">
		  </div>
		  <button id="addUser" class="btn btn-primary ml15">添加</button>
	  	<table class="hovertable">
				<tr>
					<th>编号</th><th>姓名</th><th>城市</th><th>操作</th>
				</tr>
				<tbody id="userList">

				</tbody>
			</table>
		</div>


		<div id="addUserTip" class="alert alert-success hidden" role="alert">
		  <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="false"></span>
		  <span class="sr-only">Error:</span>
		  添加成功
		</div>


	</div>
	<div name="content" id="peizhi" hidden>
		<div class="form-inline" style="padding:60px;">
		  <div class="form-group">
		    <label for="exampleInputName2">分</label>
		    <input type="number" class="form-control" id="groups" min="1" placeholder="几">
		    <label for="exampleInputName2">组</label>
		  </div>
		  <div class="form-group ml15">
		    <label for="exampleInputEmail2">比</label>
		    <input type="number" class="form-control" id="counts" min="1" placeholder="几">
		    <label for="exampleInputName2">场</label>
		  </div>
		  <button id="configBtn" class="btn btn-primary ml15">提交</button>
		</div>
	</div>

	<div name="content" id="chouqian" hidden>
		<div class="form-inline" style="padding:60px 0 0;">
		  <button id="drawBtn" class="btn btn-primary ml15">开始抽签</button>
		</div>


		<div id="genterLayer" class="alert alert-success hidden" role="alert" style="margin:15px;">
		  <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="false"></span>
		  <span id="generTip"></span>
		</div>


		<ul name="groupTitle" id="chouqianTitle" class="nav nav-tabs hidden" style="padding:10px 0 0 15px;">
		</ul>


		<div id="chouqianTables" class="hidden">
			<!-- <table class="hovertable drawtable " >
				<tr>
					<th>用户编号</th><th>分组</th><th>场数</th><th>钓位</th><th>姓名</th><th>地区</th>
				</tr>
				<tbody id="drawList">
					
				</tbody>
			</table> -->
		</div>
		

	</div>

	<div name="content" id="chengji" hidden>
		<ul name="groupTitle" id="chengjiTitle" class="nav nav-tabs" style="padding:10px 0 0 15px;">
		</ul>

		<div class="tabbable" >
      

      <div id="countsContent" class="tab-content">
        <table id="chengjiTable" class="hovertable drawtable hidden" >
					<tr>
						<th>钓位</th><th>姓名</th><th>成绩</th>
					</tr>
					<tbody id="chegnjiList">
						
					</tbody>
				</table>
				<button id="saveBtn" class="btn btn-primary ml15">保存</button>
      </div>

      <div class="dropup" style="padding:15px;">
			  <button class="btn btn-default dropdown-toggle" type="button" id="countsSel" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
			    选择场数
			    <span class="caret"></span>
			  </button>
			  <ul id="chengjiCounts" class="dropdown-menu" aria-labelledby="dropdownMenu2">
			  </ul>
			</div>



    </div>

		<div>

		</div>
	</div>
	<div name="content" id="mingci" hidden>

		<ul id="mingciTitle" class="nav nav-tabs" style="padding:10px 0 0 15px;">
		</ul>



		<div class="bs-example" data-example-id="hoverable-table">
	    <table class="table table-hover ranktable">
	      <thead id="rankTitle" align="center" valign="middle" style="font-weight:bold;">
	      </thead>
	      <tbody id="rankList" align="center" valign="middle">
	        
	      </tbody>
	    </table>
	  </div>
	</div>

</body>
<script src="jquery.js"></script>
<script src="js/bootstrap.min.js"></script>
<script>


	function pad(num, n) {
	    var len = num.toString().length;
	    while(len < n) {
	        num = '0' + num;
	        len++;
	    }
	    return num;
	}

	$(function() {


		var db = openDatabase('IntegralDB', '1.0', 'Integral DB', 100 * 1024 * 1024);
		if (!localStorage.useridStart) {
			localStorage.useridStart = 1;
		}
		//删除表
		// db.transaction(function (tx) {
		// 	tx.executeSql('drop table Groups',[]);
		// 	tx.executeSql('drop table Fishpos',[],function() {
		// 		alert('s')
		// 	},function() {
		// 		alert('e')
		// 	});
		// });


		window.delUser = function (uid) {
			var name = $('#userlist_'+uid).find('td span').eq(0).text();
			var city = $('#userlist_'+uid).find('td span').eq(1).text();
			var r = confirm('确定删除<'+city+'> ' + name + '吗？删除后抽签及成绩将也会被删除');
			if (r === true) {
	    	db.transaction(function (context) {
	    		context.executeSql('DELETE FROM Groups WHERE userid = ?', [uid]);
	    		context.executeSql('DELETE FROM Fishpos WHERE userid = ?', [uid]);
	        context.executeSql('DELETE FROM User WHERE id = ?', [uid], function (context, results) {
	          if (results.rows) {
	          	$('#userlist_'+uid).remove();
	          	generationLastRanking();
	          	renderChouqian(1);
	          } else {
	          	alert('删除失败!');
	          }
	       	});
	    	});
			}

		}
		
		// window.editUserName = function (uid, name, el) {
		// 	// var name = prompt('请输入名字', name);
		// 	if (name) {
	 //    	db.transaction(function (context) {
	 //    		context.executeSql('UPDATE Groups SET username = ? WHERE userid = ?', [name, uid]);
	 //    		context.executeSql('UPDATE Fishpos SET username = ? WHERE userid = ?', [name, uid]);
	 //        context.executeSql('UPDATE User SET name = ? WHERE id = ?', [name, uid], function (context, results) {
	 //          if (results.rows) {
	 //          	$('#userlist_'+uid).find('td span').eq(0).text(name);
	 //          	generationLastRanking();
		// 					renderChouqian(1);
	 //          } else {
	 //          	alert('更新失败!');
	 //          }
	 //       	});
	 //    	});
		// 	}
		// }

		// window.editUserCity = function (uid) {
		// 	var city = $('#userlist_'+uid).find('td span').eq(1).text();
		// 	var city = prompt('请输入城市', city);
		// 	if (city) {
		// 		db.transaction(function (context) {
		// 			context.executeSql('UPDATE Groups SET usercity = ? WHERE userid = ?', [city, uid]);
	 //    		context.executeSql('UPDATE Fishpos SET usercity = ? WHERE userid = ?', [city, uid]);
	 //        context.executeSql('UPDATE User SET city = ? WHERE id = ?', [city, uid], function (context, results) {
	 //          if (results.rows) {
	 //          	$('#userlist_'+uid).find('td span').eq(1).text(city);
	 //          	generationLastRanking();
	 //          	renderChouqian(1);
	 //          } else {
	 //          	alert('更新失败!');
	 //          }
	 //       	});
	 //    	});
		// 	}
		// }

		$('.first-tabs').on('click', 'li',	function() {
			var name = $(this).attr('name');
			$('.first-tabs').find('li.active').removeClass('active');
			$('div[name=content]').attr('hidden', true);
			$('#'+name).removeAttr('hidden');
			$(this).addClass('active');

			if(name == 'chengji' && $('#chengjiCounts').find('li')[0]) {
				$('#chengjiCounts').find('li').first().trigger('click');
				$('#chengjiTable').removeClass('hidden')
			}

		});


		//重置比赛
		$('#resetBtn').on('click',	function() {
			 var r = confirm("确定要重置比赛？")
		   if(r){
		     clearDB();
		   }
		});

		//重置数据库
		function clearDB() {
			var count = 0;

			db.transaction(function (tx) {
				tx.executeSql('drop table User',[],function() {
					count++;
					if(count === 3) {
						delete localStorage.counts;
						delete localStorage.groups;
						window.location.reload();
					}
				});
				tx.executeSql('drop table Groups',[],function() {
					count++;
					if(count === 3) {
						delete localStorage.counts;
						delete localStorage.groups;
						window.location.reload();
					}
				});
				tx.executeSql('drop table Fishpos',[],function() {
					count++;
					if(count === 3) {
						delete localStorage.counts;
						delete localStorage.groups;
						window.location.reload();
					}
				});

			});


		}


		//添加用户
		$('#addUser').on('click',	function() {
			var name = $('#userName').val();
			var city = $('#userCity').val();
			var id = pad(localStorage.useridStart, 3);
			localStorage.useridStart ++;

			if(db) {
				db.transaction(function (context) {
					context.executeSql('CREATE TABLE IF NOT EXISTS User (id unique, name, city)');
					context.executeSql('INSERT INTO User (id, name, city) VALUES (?,?,?)', [id, name, city],	function() {
						$('#addUserTip').show();
						$('#userName').val('').focus();
						$('#userCity').val('');
						renderData();
						setTimeout(function() {
							$('#addUserTip').hide();
						}, 1000)
					}, function(tx, error) {
						alert('添加数据失败: ' + error.message);
					});
	      });
			}
		});


		function initConfig() {
			if(localStorage.groups || localStorage.counts) {
				$('#groups').val(localStorage.groups);
				$('#counts').val(localStorage.counts);

				renderMingciTitle()
			}
		}
			
	
		initConfig();

		//渲染第1场，第2场 ， 总排名
		function renderMingciTitle() {
			var htmlStr = '';
			for(var i=0; i<localStorage.counts; i++) {
				htmlStr += '<li><a href="javascript:;">第'+(i+1)+'场</a></li>'
			}
			htmlStr += '<li class="active" name="all"><a href="javascript:;">总排名</a></li>'

			$('#mingciTitle').html(htmlStr);

			//临时去掉 TODO
			// $('#mingciTitle').addClass('hidden');
		}

		//tab切换
		$('#mingciTitle').on('click', 'li',	function() {
			var name = $(this).attr('name');
			var index = $(this).index() + 1;
			$('#mingciTitle').find('li.active').removeClass('active');
			$(this).addClass('active');
			if(name === 'all') { //生成总排名
				generationLastRanking();
			}else{
				generationLastRanking(index);
			}
		});


		$('#configBtn').on('click',	function() {
			var groups = $('#groups').val();
			var counts = $('#counts').val();

			localStorage.groups = groups;
			localStorage.counts = counts;

			if(groups && counts) {
				renderMingciTitle();
				alert('配置成功！');
			}


		});

		//初始化 组 和 场
		function initGroupAndCounts() {
			if(localStorage.groups) {
				var htmlStr = '';
				for(var i=0; i<localStorage.groups; i++) {
					if(i == 0) {
						htmlStr += '<li groupname="第'+(i+1)+'组" class="active"><a href="javascript:;">第'+(i + 1)+'组</a></li>'
					}else{
						htmlStr += '<li groupname="第'+(i+1)+'组" ><a href="javascript:;">第'+(i + 1)+'组</a></li>'
					}
				}
				$('ul[name=groupTitle]').html(htmlStr);
			}

			if(localStorage.counts) {
				var htmlStr = '';
				for(var i=0; i<localStorage.counts; i++) {
					htmlStr += '<li><a href="javascript:;">第'+(i+1)+'场</a></li>'
				}
				$('#chengjiCounts').html(htmlStr);
			}
		}

		initGroupAndCounts();


		function renderChouqian(index) {
			index = index || 1;
			var htmlStr = '';
			var counts = localStorage.counts;
			var userObj = {};

			

			getDataFromDBWhere(function(data) {
					// counts: 1
					// fish_num: ""
					// groupname: "第1组"
					// grouppos: 0
					// id: null
					// ranking: 0
					// usercity: "杭州s"
					// userid: "49056280"
					// username: "w"
					// weight: ""
					$.each(data,	function(k, v) {
						if(!userObj[v['userid']]) {
							userObj[v['userid']] = {};
							userObj[v['userid']] = v;
						}

						userObj[v['userid']]['pos_' + v['counts']] = v['grouppos'];
						
					});

					htmlStr += '<table class="hovertable drawtable" >'
					+'<tr>'
					+'<th>用户编号</th><th>姓名</th><th>地区</th>'
					for(var i=0; i<counts; i++) {
						htmlStr += '<th>第'+(i+1)+'场钓位</th>'
					}
					+'</tr>'
					+'<tbody>'

					$.each(userObj,	function(k, v) {
						htmlStr += '<tr>'
						+'	<td>'+v['userid']+'</td><td>'+v['username']+'</td><td>'+v['usercity']+'</td>'
						for(var j=0; j<localStorage.counts; j++) {
							htmlStr += '<td>'+(v['pos_'+(j+1)]+1)+'</td>'
						}
						htmlStr += '</tr>'
					});

					htmlStr += '</tbody></table>'
					$('#chouqianTables').html(htmlStr).removeClass('hidden');

					$('ul[name=groupTitle]').removeClass('hidden');
					$('#genterLayer').addClass('hidden');

			}, 'Fishpos' , '第' + index + '组');

			
		}

		//渲染抽签表格
		// function renderChouqianDoms(data) {
		// 	var htmlStr =  '';

		// 	htmlStr += '<table class="hovertable drawtable" >'
		// 		+'<tr>'
		// 		+'<th>用户编号</th><th>场数</th><th>钓位</th><th>姓名</th><th>地区</th>'
		// 		+'</tr>'
		// 		+'<tbody>'
		// 		for(var i=0; i<data.length; i++) {
		// 			htmlStr += '<tr>'
		// 				+'	<td>'+data[i]['userid']+'</td><td>'+data[i]['counts']+'</td><td>'+(data[i]['grouppos'] + 1)+'</td><td>'+data[i]['username']+'</td><td>'+data[i]['usercity']+'</td>'
		// 				+'</tr>'
		// 		}
		// 		htmlStr += '</tbody>'
		// 		+'</table>'


		// 	$('#chouqianTables').append(htmlStr);

		// 	$('#chouqianTables').removeClass('hidden')
		// }

		//默认为1
		renderChouqian(1);

		var count = 0;
		//开始抽签
		$('#drawBtn').on('click',	function() {

			db.transaction(function (tx) {
				tx.executeSql('DELETE FROM Groups');
			});

			db.transaction(function (tx) {
				tx.executeSql('DELETE FROM Fishpos');
			});

			$('#genterLayer').removeClass('hidden');

			$('#generTip').text('正在分组...');
			$('.drawtable').addClass('hidden');
			$('ul[name=groupTitle]').addClass('hidden');


			if(localStorage.groups && localStorage.counts) {

				initGroupAndCounts();

				getUserList(function(data) {
					count = data.length;
					for(var i=0; i<data.length; i++){
						var which = i%localStorage.groups;
						inserGroupData(data[i], '第' + ( which + 1 ) + '组');
					}
				});
			}else{
				alert('请先配置场数和分组');
			}
		});

		//抽签分组
		$('#chouqianTitle').on('click', 'li', function() {
			var index = $(this).index();
			$('#chouqianTitle').find('li.active').removeClass('active');
			$(this).addClass('active');

			$('#chouqianTables').html('');
			renderChouqian(index + 1);

		});


		//选择场数
		$('#chengjiCounts').on('click', 'li',	function() {
			var index = $(this).index();
			$('#countsSel').text('第'+(index+1)+'场');
			$('#chengjiCounts').data('cur', index);

			renderSubmitData(index + 1);
		});


		function renderSubmitData(index){

			var groupname = $('#chengjiTitle').find('li.active').attr('groupname');
			getDataFromDBWhere2(function(data) {
				var htmlStr =  '';
				var htmlStr = '';
				for(var i=0; i<data.length; i++) {
					var oldValue = data[i]['fish_num'] || data[i]['weight'];
					if(oldValue) {
						htmlStr += '<tr>'
						+'	<td>'+(data[i]['grouppos'] + 1)+'</td><td>'+data[i]['username']+'</td><td><input uid="'+data[i]['userid']+'" type="text" value="'+oldValue+'" /></td>'
						+'</tr>'
					}else{
						htmlStr += '<tr>'
						+'	<td>'+(data[i]['grouppos'] + 1)+'</td><td>'+data[i]['username']+'</td><td><input uid="'+data[i]['userid']+'" type="text" /></td>'
						+'</tr>'
					}
				}
				$('#chegnjiList').html(htmlStr);
			}, 'Fishpos' , groupname, index);

		}


		$('#chengjiTitle').on('click', 'li', function() {
			$('#chengjiTitle').find('li.active').removeClass('active');
			$(this).addClass('active');
			var index = Number($('#chengjiCounts').data('cur'));

			renderSubmitData(index+1);
		});


		//根据组数 创建group表
		function inserGroupData(user, groupname) {
			db.transaction(function (context) {
				var id = String(+new Date()).substring(5);
				var name = user['name'];
				var city = user['city'];
				var userid = user['id'];

				context.executeSql('CREATE TABLE IF NOT EXISTS Groups (groupname, userid, username, usercity)');
				context.executeSql('INSERT INTO Groups (groupname, userid, username, usercity) VALUES (?,?,?,?)', [ groupname, userid, name, city],	function() {
					count--;
					if(count === 0) {//添加完毕
						$('#generTip').text('分组成功！');
						setTimeout(function() {
							exesGroupPos();
						}, 500);
					}
				}, function(tx, error) {
					alert('添加Groups数据失败: ' + error.message);
				});
      });
		}

		var groupPosCount = 0;
		//
		function exesGroupPos() {
			$('#generTip').text('正在分配钓位...');
			var obj = {};
			getDataFromDB(function(data) {

				groupPosCount = data.length;
				$.each(data,	function(key, val) {
					if(!obj[val['groupname']]) {
						obj[val['groupname']] = [];
					}
					obj[val['groupname']].push(val);
				});

				$.each(obj,	function(key, val) {
					for(var j=0; j<localStorage.counts; j++) {
						var rArr = randoms(val.length);
						for(var i=0; i<val.length; i++) {
							generateGroupTable({
								'name' : val[rArr[i]]['username'],
								'city' : val[rArr[i]]['usercity'],
								'id' : val[rArr[i]]['userid']
							}, key, i, j + 1);
						}
					}
				});
			}, 'Groups');
		}

		//随机打乱
		function randoms(len) {
			var arr = []; 
			for(var i = 0;i < len;i++){ 
				arr[i] = i; 
			} 
			arr.sort(function(){ return 0.5 - Math.random() }) 
			var str = arr.join(); 
			return arr;
		}

		//根据组数 生成每组钓位表
		function generateGroupTable(user, groupname, grouppos, counts) {
			db.transaction(function (context) {
				var id = String(+new Date()).substring(5);
				var name = user['name'];
				var city = user['city'];
				var userid = user['id'];

				context.executeSql('CREATE TABLE IF NOT EXISTS Fishpos (groupname, grouppos ,userid, username, usercity, counts, fish_num, weight, ranking)');
				context.executeSql('INSERT INTO Fishpos ( groupname, grouppos ,userid, username, usercity, counts, fish_num, weight, ranking) VALUES (?,?,?,?,?,?,?,?,?)', [groupname, grouppos, userid, name, city, counts, '', '', 0],	function() {
					groupPosCount--;
					if(groupPosCount === 0) {
						$('#generTip').text('钓位分配成功！');
						setTimeout(function() {
							$('#generTip').text('正在生成表格...');
							renderChouqian(1);
						}, 1000);
					}
				}, function(tx, error) {
					alert('添加Fishpos数据失败: ' + error.message);
				});
      });
		}



		function renderData() {
			getUserList(function(data) {
				var htmlStr = '';
				for(var i=0; i<data.length; i++) {
					// htmlStr += '<tr id="userlist_'+data[i]['id']+'">'
					// +'	<td>'+data[i]['id']+'</td><td ondblclick="return editUserName(\''+data[i]['id']+'\',\''+data[i]['name']+'\',\'this\')">'+data[i]['name']+'</td><td><span>'+data[i]['city']+'</span><a href="javascript:;" class="userOptionEdit" onClick="return editUserCity(\''+data[i]['id']+'\')">修改</a></td><td><a href="javascript:;" class="userOptionDel" onClick="return delUser(\''+data[i]['id']+'\')">删除</a></td>'
					// +'</tr>'


					htmlStr += '<tr id="userlist_'+data[i]['id']+'">'
					 +'<td>'+data[i]['id']+'</td><td name="td_name" uid="'+data[i]['id']+'" style="width:150px;">'+data[i]['name']+'</td><td name="td_city" uid="'+data[i]['id']+'" style="width:150px;">'+data[i]['city']+'</td><td><a href="javascript:;" class="userOptionDel" onClick="return delUser(\''+data[i]['id']+'\')">删除</a></td>'
					+'</tr>'


				}
				$('#userList').html(htmlStr);
			});
		}

		renderData();


		//双击修改姓名
		$('#userList').on('dblclick', 'td[name=td_name]',	function() {
			var name = $(this).text();
			var uid = $(this).attr('uid');
			$(this).html('<input name="td_name" type="text" value="'+name+'" uid="'+uid+'" style="width:130px;" >');
			$(this).find('input').focus().select();
		});

		//丢失焦点
		$('#userList').on('blur',	'input[name=td_name]',	function() {
			var newName = $(this).val();
			var uid = $(this).attr('uid');
			var self = this;
			if (newName) {
	    	db.transaction(function (context) {
	    		context.executeSql('UPDATE Groups SET username = ? WHERE userid = ?', [newName, uid]);
	    		context.executeSql('UPDATE Fishpos SET username = ? WHERE userid = ?', [newName, uid]);
	        context.executeSql('UPDATE User SET name = ? WHERE id = ?', [newName, uid], function (context, results) {
	          if (results.rows) {
	          	$('#userlist_'+uid).find('td span').eq(0).text(newName);
	          	$(self).parent().html(newName);
	          	generationLastRanking();
							renderChouqian(1);
	          } else {
	          	alert('更新失败!');
	          }
	       	});
	    	});
			}
		});


		//双击修改城市
		$('#userList').on('dblclick', 'td[name=td_city]',	function() {
			var name = $(this).text();
			var uid = $(this).attr('uid');
			$(this).html('<input name="td_city" type="text" value="'+name+'" uid="'+uid+'" style="width:130px;" >');
			$(this).find('input').focus().select();
		});

		//丢失焦点
		$('#userList').on('blur',	'input[name=td_city]',	function() {
			var newCity = $(this).val();
			var uid = $(this).attr('uid');
			var self = this;
			if (newCity) {
				db.transaction(function (context) {
					context.executeSql('UPDATE Groups SET usercity = ? WHERE userid = ?', [newCity, uid]);
	    		context.executeSql('UPDATE Fishpos SET usercity = ? WHERE userid = ?', [newCity, uid]);
	        context.executeSql('UPDATE User SET city = ? WHERE id = ?', [newCity, uid], function (context, results) {
	          if (results.rows) {
	          	$('#userlist_'+uid).find('td span').eq(1).text(newCity);
	          	$(self).parent().html(newCity);
	          	generationLastRanking();
	          	renderChouqian(1);
	          } else {
	          	alert('更新失败!');
	          }
	       	});
	    	});
			}
		});


    function getUserList(callback) {
    	db.transaction(function (context) {
        context.executeSql('SELECT * FROM User ORDER BY rowid DESC', [], function (context, results) {
          var len = results.rows.length, i;
          var arrs = [];
          for (i = 0; i < len; i++){
          	var obj = {};
            obj = {
            	'id' : results.rows.item(i).id,
            	'name' : results.rows.item(i).name,
            	'city' : results.rows.item(i).city
            }
            arrs.push(obj);
          }
          callback(arrs);
       	});
    	});
    }


    function getDataFromDB(callback, tName) {
    	db.transaction(function (context) {
        context.executeSql('SELECT * FROM ' + tName, [], function (context, results) {
          callback(results.rows);
       	});
    	});
    }

    function getDataFromDBWhere(callback, tName, groupname) {
    	db.transaction(function (context) {
        context.executeSql('SELECT * FROM ' + tName + ' WHERE groupname = ?', [groupname], function (context, results) {
          callback(results.rows);
       	});
    	});
    }

    function getDataFromDBWhere2(callback, tName, groupname, counts) {
    	db.transaction(function (context) {
        context.executeSql('SELECT * FROM ' + tName + ' WHERE groupname = ? and counts = ?', [groupname, counts], function (context, results) {
          callback(results.rows);
       	});
    	});
    }

    function inserChengjiToFishpos(callback, fish_num, weight, uid, counts) {
    	db.transaction(function (context) {
        context.executeSql('UPDATE Fishpos SET fish_num = ?, weight = ? WHERE userid = ? and counts = ?', [fish_num, weight, uid, counts], function (context, results) {
          callback();
       	});
    	});
    }

    function getChengjiAllNum(callback) {
    	db.transaction(function (context) {
        context.executeSql('SELECT * FROM Fishpos WHERE weight = "" and fish_num =""', [], function (context, results) {
          callback(results);
       	});
    	});
    }


    //输入成绩格式拦截
    $('#chegnjiList').on('blur', 'input',	function() {
    	var value = $(this).val();
    	if(isNaN(value)){
			  alert('请输入数字！')
			  $(this).val('').focus();
			}
    });

     //录入成绩
     $('#saveBtn').on('click',	function() {
     		var inputs = $('#chegnjiList').find('input');
     		var newValueArr = [], isFishNum = true;
     		for(var i=0; i<inputs.length; i++) {
     			var curValue = inputs.eq(i).val();
     			newValueArr.push({
     				'uid' : inputs.eq(i).attr('uid'),
     				'chengji' : curValue
     			});
     			if(!curValue) {
     				alert('请输入成绩！');
			  		inputs.eq(i).val('').focus();
			  		return;
     			}
     			if(parseInt(curValue) != curValue){
						isFishNum = false;
					}
     		}

     		var counts = Number($('#chengjiCounts').data('cur')) + 1;

     		for(var i=0; i<newValueArr.length; i++) {
     			var fish_num = 0, weight = 0, curCount = 0;
     			var uid = newValueArr[i]['uid'];
     			if(isFishNum) {
	     			fish_num = newValueArr[i]['chengji'];
	     		}else{
	     			weight = newValueArr[i]['chengji'];
	     		}

     			inserChengjiToFishpos(function(result) {
     				curCount++;
     				if(newValueArr.length == curCount) {
     						alert('保存成功！')
								initGenerationLastRanking();
     				}
     			}, fish_num, weight, uid, counts);
     		}
     });
	

		function initGenerationLastRanking() {
					generationLastRanking();
			getChengjiAllNum(function(data) {
				if(data.rows.length == 0) {
					//生成名次表格
				}
			})
		}
		
		initGenerationLastRanking();

		//得总排名
		function generationLastRanking(perCounts){
			var htmlStr = '';

			htmlStr += '<tr>'
      		+'<td rowspan="2" class="pt30" valign="middle">编号</td>'
      		+'<td rowspan="2" class="pt30" valign="middle">地区</td>'
      		+'<td rowspan="2" class="pt30">姓名</td>'

      if(perCounts) {
					htmlStr += '<td colspan="2">第'+perCounts+'场</td>'
      }else{
      	for(var i=0; i<localStorage.counts; i++) {
					htmlStr += '<td colspan="2">第'+(i+1)+'场</td>'
				}
      }

			

			htmlStr += '<td id="totalNum" rowspan="2" class="pt30">总得分</td><td id="totalRank" rowspan="2" class="pt30" valign="middle">总排名</td></tr><tr>'

			if(perCounts) {
				htmlStr += '<td>成绩</td><td>得分</td>'
			}else{
				for(var i=0; i<localStorage.counts; i++) {
					htmlStr += '<td>成绩</td><td>得分</td>'
				}
			}
      
      htmlStr += '</tr>';

			$('#rankTitle').html(htmlStr);


			// rankList
			getDataFromDB(function(data) {
				analyticalData(data, perCounts);
			}, 'Fishpos');



		}

		//各种解析rank
		function analyticalData(data, perCounts) {

			if(perCounts) {
				var newDataArr = [];
				for(var i=0; i<data.length; i++) {
					if(data[i]['counts'] == perCounts) {
						newDataArr.push(data[i]);
					}
				}

				data = newDataArr;
			}


			var arrs = [], groupsObj = {}, countsObj = {};
			var userObj = {};

			
			for(var i=0; i<localStorage.groups; i++) {
				groupsObj['group_'+(i+1)] = [];
			}
			
			if(perCounts) {
				countsObj['counts_'+perCounts] = {};
				for(var j=0; j<localStorage.groups; j++) {
					countsObj['counts_'+perCounts]['group_'+(j+1)] = [];
				}
			}else{
				for(var i=0; i<localStorage.counts; i++) {
					countsObj['counts_'+(i+1)] = {};
					for(var j=0; j<localStorage.groups; j++) {
						countsObj['counts_'+(i+1)]['group_'+(j+1)] = [];
					}
				}
			}
			
			
			for(var i=0; i<data.length; i++) {
				data[i]['fish_num'] = Number(data[i]['fish_num']);
				data[i]['weight'] = Number(data[i]['weight']);
				var group = data[i]['groupname'].replace('第','').replace('组','');
				
				var counts = data[i]['counts'];

				if(perCounts) {
					counts = perCounts;
				}


				if(!userObj[data[i]['userid']]) {
					userObj[data[i]['userid']] = data[i];
				}

				if(countsObj['counts_'+counts]['group_'+group] instanceof Array) {
					countsObj['counts_'+counts]['group_'+group].push(data[i]);
				}

			}


			//计算组内排名
			$.each(countsObj,	function(key, val) {
				$.each(val,	function(k, v) {
					if(v[0]['fish_num']) {
						v.sort(compare('fish_num'));
					}else if(v[0]['weight']){
						v.sort(compare('weight'));
					}
				});
			});


			//写入ranking(分组排名)
			$.each(countsObj,	function(key, val) {
				$.each(val,	function(k, v) {
				 	var r = 0;
				 	var last = -1;
				 	var uList = [];
					for(var i=0; i<v.length; i++) {
						if (v[i]['ranking'] <= 0) {
							v[i]['ranking'] = 1000;
						}
						if(v[i]['fish_num']) {
							var _last = v[i]['fish_num'];
						} else if(v[i]['weight']) {
							var _last = v[i]['weight'];
						} else {
							continue;
						}
						if (last == _last || i == 0) {
							r += (i + 1);
							uList.push(i);
						} else {
							//开始结算前面的
							for (var ii = 0; ii < uList.length; ii ++) {
								v[uList[ii]]['ranking'] = r > 0 ? Math.floor(r * 10 / uList.length) / 10 : '-';
							}
							uList = [i];
							r = i + 1;
						}
						last = _last;
					}
					if (r > 0) {
						//开始结算前面的
						for (var ii = 0; ii < uList.length; ii ++) {
							v[uList[ii]]['ranking'] = r > 0 ? Math.floor(r * 10 / uList.length) / 10 : '-';
						}
					}
				});
			});

			$.each(countsObj,	function(key, val) {
				$.each(val,	function(k, groupItem) {
					for(var i=0; i<groupItem.length; i++) {
						userObj[groupItem[i]['userid']][key] = groupItem[i]['ranking'];
						userObj[groupItem[i]['userid']][key+'_type'] = groupItem[i]['fish_num'] ? 'num' : 'weight';
						userObj[groupItem[i]['userid']][key+'_value'] = groupItem[i]['fish_num'] || groupItem[i]['weight'];
					}
				});
			}); 
			
			if(perCounts) {
				renderBodyRankPerCount(userObj, perCounts);
			}else{
				renderBodyRank(userObj);
			}
		}


		function eachTwo(val) {
			
		}


		function compare(propertyName) { 
			return function (object1, object2) { 
				var value1 = Number(object1[propertyName]); 
				var value2 = Number(object2[propertyName]); 
				if (value2 < value1) { 
					return -1; 
				} 
				else if (value2 > value1) { 
					return 1; 
				}
				else { 
					return 0; 
				} 
			} 
		} 


		function compare2(propertyName, perCounts) { 
			return function (object1, object2) { 
				var value1 = Number(object1[propertyName]); 
				var value2 = Number(object2[propertyName]);
				
				if (value2 > value1) { 
					return -1; 
				} 
				else if (value2 < value1) { 
					return 1; 
				}
				else {
					//总分一样
					var c1 = [];
					var c2 = [];
					var c1v_weight = 0;
					var c2v_weight = 0;
					var c1v_num = 0;
					var c2v_num = 0;


					if(perCounts) {
							c1.push(object1['counts_' + perCounts]);
							c2.push(object2['counts_' + perCounts]);
							if (object1['counts_' + perCounts + '_type'] == 'num') {
								c1v_num += Number(object1['counts_' + perCounts + '_value']);
							} else {
								c1v_weight += Number(object1['counts_' + perCounts + '_value']);
							}
							if (object1['counts_' + perCounts + '_type'] == 'num') {
								c2v_num += Number(object2['counts_' + perCounts + '_value']);
							} else {
								c2v_weight += Number(object2['counts_' + perCounts + '_value']);
							}
					}else{
						for(var j=0; j<localStorage.counts; j++) {
							c1.push(object1['counts_' + (j+1)]);
							c2.push(object2['counts_' + (j+1)]);
							if (object1['counts_' + (j+1) + '_type'] == 'num') {
								c1v_num += Number(object1['counts_' + (j+1) + '_value']);
							} else {
								c1v_weight += Number(object1['counts_' + (j+1) + '_value']);
							}
							if (object1['counts_' + (j+1) + '_type'] == 'num') {
								c2v_num += Number(object2['counts_' + (j+1) + '_value']);
							} else {
								c2v_weight += Number(object2['counts_' + (j+1) + '_value']);
							}
						}
					}

					
					var c1s = c1.sort(function(a, b) { return a-b;});
					var c2s = c2.sort(function(a, b) { return a-b;});
					//> 0 降序， < 0 升序
					for (var i = 0; i < c1s.length; i++) {
						if (c1s[i] > c2s[i]) {
							return 1;
						} else if (c1s[i] < c2s[i]) {
							return -1;
						}
					}
					if (c1v_num > c2v_num) {
						return -1;
					} else if (c1v_num < c2v_num) {
						return 1;
					}

					if (c1v_weight > c2v_weight) {
						return -1;
					} else if (c1v_weight < c2v_weight) {
						return 1;
					}
					

					return 0;
				} 
			} 
		} 


		//渲染排名表格体
		function renderBodyRank(data) {

			$('#totalNum').removeClass('hidden');
			$('#totalRank').removeClass('hidden').text('总排名');

			var htmlStr = '',count = 1, userArr = [];
			$.each(data,	function(key, val) {
				var totalRank = 0;
				for(var j=0; j<localStorage.counts; j++) {
					if (val['counts_'+(j+1)] == 1000) {
						continue;
					}
					totalRank += val['counts_'+(j+1)];
				}

				val['totalRank'] = totalRank == 0 ? 1000 : totalRank;
				console.log(val['totalRank'])
				userArr.push(val);
			});
			userArr.sort(compare2('totalRank'));

			for(var i=0; i<userArr.length; i++) {
					htmlStr += '<tr><td>'+userArr[i]['userid']+'</td>'
					+'<td>'+userArr[i]['usercity']+'</td>'
					+'<td>'+userArr[i]['username']+'</td>'
				for(var j=0; j<localStorage.counts; j++) {
					htmlStr += '<td>'+userArr[i]['counts_'+(j+1)+'_value']+'</td><td>'+(userArr[i]['counts_'+(j+1)] == 1000 ? '-': userArr[i]['counts_'+(j+1)])+'</td>'
				}
				htmlStr += '<td>'+(userArr[i]['totalRank'] == 1000 ? '-' : userArr[i]['totalRank'])+'</td><td>'+(i+1)+'</td><tr></tr>'
			}

			$('#rankList').html(htmlStr);
		}



		//渲染排名表格体
		function renderBodyRankPerCount(data, counts) {
			var htmlStr = '', userArrs = {};

			$('#totalNum').addClass('hidden');
			$('#totalRank').addClass('hidden');//.text('排名');

			$.each(data,	function(key, val) {
				if (!userArrs[val['groupname']]) {
					userArrs[val['groupname']] = [];
				}
				userArrs[val['groupname']].push(val);
			});

			$.each(userArrs,	function(key, userArr) {

				userArr.sort(compare2('counts_'+(counts)), counts);
				htmlStr += '<tr><td colspan="5" style="font-size:22px;font-weight:bold;">'+key+'</td></tr>';
				for(var i=0; i<userArr.length; i++) {
						htmlStr += '<tr><td>'+userArr[i]['userid']+'</td>'
						+'<td>'+userArr[i]['usercity']+'</td>'
						+'<td>'+userArr[i]['username']+'</td>'
						+'<td>'+(userArr[i]['counts_'+(counts)+'_value'] > 0 ? userArr[i]['counts_'+(counts)+'_value'] : '-')+'</td><td>'+(userArr[i]['counts_'+(counts)] == 1000 ? '-': userArr[i]['counts_'+(counts)])+'</td>'
					htmlStr += '</tr>'//'<td>'+(i+1)+'</td>
				}
			})

			// $.each(data,	function(key, val) {
			// 	var totalRank = 0;
			// 	totalRank += val['counts_'+(counts)];

			// 	// val['totalRank'] = totalRank;
			// 	userArr.push(val);
			// });
			// userArr.sort(compare2('totalRank'), counts);

			// for(var i=0; i<userArr.length; i++) {
			// 		htmlStr += '<tr><td>'+userArr[i]['userid']+'</td>'
			// 		+'<td>'+userArr[i]['usercity']+'</td>'
			// 		+'<td>'+userArr[i]['username']+'</td>'
			// 		+'<td>'+(userArr[i]['counts_'+(counts)+'_value'] > 0 ? userArr[i]['counts_'+(counts)+'_value'] : '-')+'</td><td>'+(userArr[i]['counts_'+(counts)] == 1000 ? '-': userArr[i]['counts_'+(counts)])+'</td>'
			// 	htmlStr += '<td>'+(i+1)+'</td><tr></tr>'
			// }

			$('#rankList').html(htmlStr);
		}
		
	});
</script>
</html>